#!/bin/bash
##
## yad dialog to download and save youtube video
##
## written by <damo> June 2015

CMD="youtube-dl -o "
FTYPES="mp4!avi!mov!wmv!flv!3gp!mkv"

progbar(){                                      # progress bar
    while :; do
        echo ""
        sleep 1s
    done | DLG=$(yad --progress --pulsate --auto-kill \
            --window-icon=distributor-logo-bunsenlabs \
            --center --undecorated --text="Youtube downloader: Progress..." \
            )
    if [[ $? = 0 ]];then
        YKILL=$(pgrep -a youtube-dl | awk '{print $1}')
        kill -SIGKILL $YKILL
        if ! [[ $(pidof youtube-dl) ]];then
            notify-send 'Download cancelled' --expire-time=5000 --icon=dialog-information &
            if [[ -f "$RECORDING.part" ]];then
                rm "$RECORDING.part"
            fi
            exit
        fi
    fi
}

killprog(){                                     # kill progress dialog
    if ! [[ $(pidof youtube-dl) ]];then
        notify-send 'Finished downloading youtube video' --expire-time=5000 --icon=dialog-information &
    fi
    pgrep -a yad | while read pid cmd; do 
        if echo "$cmd" | grep "Progress" &>/dev/null; then
            kill "$pid"
        fi     
    done
}

while :; do
    ENTRY=$(yad --form --window-icon=distributor-logo-bunsenlabs --center \
        --title="Youtube downloader" \
        --field="Enter Filename":SFL \
        --field="Enter youtube url" \
        --field="Filetype:CB" \
        "" "" "$FTYPES" \
        )
    RET=$?

    OIFS=$IFS # save Internal Field Separator
    IFS="|" # separator is "|" in returned choices
    i=0
    retChoice=()

for ret in $ENTRY;do 
    retChoice[$i]="$ret"
    i=$(($i+1))
done

    IFS=$OIFS # reset IFS back to default

    SAVE=${retChoice[0]}
    URL=${retChoice[1]}
    URL=${URL##*'='}
    FTYPE=${retChoice[2]}

    if (( $RET == 1 ));then
        exit
    fi
    if [[ -z $SAVE ]] || [[ -z $URL ]] || [[ -z $FTYPES ]];then
        yad --form --text="Complete both fields" --center --window-icon=distributor-logo-bunsenlabs
    else
        break
    fi
done

RECORDING="$SAVE.$FTYPE" # add file extension

if (( $RET == 0 ));then
    while :; do
        if [[ -f $RECORDING ]];then
            DLG=$(yad --form --window-icon=distributor-logo-bunsenlabs \
                --text="File exists. Overwrite?" \
                --title="Youtube downloader" --center --undecorated \
                )
            if (( $? == 1 ));then
                echo "Cancelled overwrite..."
                exit
            else
                rm "$RECORDING"
                break
            fi
        else
            break
        fi
    done
fi

progbar &
$CMD $RECORDING $URL && killprog

exit 0

